<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>World Hopper Labs</title>
  <style>
    :root{--bg:#0b1220;--card:#131b2d;--muted:#9fb0d0;--text:#eaf1ff;--brand:#0a69ff;--good:#19c37d;--warn:#ffd166;--bad:#ff6b6b}
    *{box-sizing:border-box} body{margin:0;background:var(--bg);color:var(--text);font:16px/1.4 system-ui,-apple-system,Segoe UI,Roboto,Inter,Arial}
    .wrap{max-width:1080px;margin:24px auto;padding:0 16px}
    h1{font-size:clamp(28px,4vw,40px);margin:8px 0 6px} .sub{color:var(--muted);margin:0 0 18px}
    .card{background:var(--card);border:1px solid #223355;border-radius:14px;box-shadow:0 10px 30px rgba(0,0,0,.25)}
    .pad{padding:18px}
    .grid{display:grid;grid-template-columns:repeat(12,1fr);gap:14px}
    .fg-4{grid-column:span 4} .fg-12{grid-column:span 12}
    label{display:block;color:var(--muted);font-size:13px;margin:0 0 6px}
    select,input[type="number"]{width:100%;background:#0e1630;color:var(--text);border:1px solid #2a3b66;border-radius:10px;padding:12px}
    .worlds{display:grid;grid-template-columns:repeat(3,minmax(0,1fr));gap:10px;margin-top:6px}
    .world{display:flex;gap:8px;align-items:flex-start;background:#0f1732;border:1px solid #24365f;padding:10px;border-radius:10px}
    .muted{color:var(--muted);font-size:12px}
    .btn{display:inline-flex;align-items:center;justify-content:center;gap:8px;padding:14px 18px;border-radius:12px;border:1px solid #245; background:var(--brand); color:white; font-weight:600; cursor:pointer}
    .btn:disabled{opacity:.5;cursor:not-allowed}
    .msg{margin:10px 0 0;font-family:ui-monospace,Menlo,Consolas,monospace;font-size:13px}
    table{width:100%;border-collapse:collapse}
    th,td{padding:12px;border-top:1px solid #223358}
    th{color:var(--muted);font-weight:600;text-align:left}
    .badge{display:inline-flex;align-items:center;gap:6px;border:1px solid #2a3b66;border-radius:999px;padding:3px 8px;font-size:12px;white-space:nowrap}
    .m{background:rgba(25,195,125,.12);border-color:rgba(25,195,125,.35)} .f{background:rgba(160,180,210,.12)}
    .stat{font-variant-numeric:tabular-nums}
    .ok{color:var(--good)} .warn{color:var(--warn)} .bad{color:var(--bad)}
    .note{color:var(--muted);font-size:12px;margin-top:10px}
    .footer{color:var(--muted);font-size:12px;margin:18px 0 40px}
    details{margin-top:8px}
    summary{cursor:pointer;color:var(--muted)}
    code{font-family:ui-monospace,Menlo,Consolas,monospace}
  </style>
</head>
<body>
  <div class="wrap">
    <h1>World Hopper Labs</h1>
    <p class="sub">Measure OSRS latency &amp; TCP pathing from your ISP + region.</p>

    <!-- Controls -->
    <div class="card pad">
      <div class="grid">
        <div class="fg-4">
          <label for="asnSel">ISP (ASN)</label>
          <select id="asnSel"></select>
        </div>
        <div class="fg-4">
          <label for="capSel">Closest capital</label>
          <select id="capSel"></select>
        </div>
        <div class="fg-4">
          <label for="portSel">TCP Port</label>
          <select id="portSel">
            <option value="43594" selected>43594</option>
            <option value="43595">43595</option>
          </select>
        </div>

        <div class="fg-12">
          <label>Worlds (select up to 5)</label>
          <div id="worldsList" class="worlds"></div>
        </div>

        <div class="fg-12">
          <button id="runBtn" class="btn">Run test</button>
          <div id="msg" class="msg muted"></div>
          <details id="dbgBox" style="display:none">
            <summary>Debug</summary>
            <pre id="dbg" class="muted" style="white-space:pre-wrap"></pre>
          </details>
        </div>
      </div>
    </div>

    <!-- Results -->
    <div class="card pad" style="margin-top:16px">
      <h2 style="margin:0 0 8px">Results</h2>
      <div class="muted" id="probeLine" style="margin-bottom:6px"></div>
      <div style="overflow:auto">
        <table>
          <thead>
            <tr>
              <th>World</th>
              <th>Members</th>
              <th>Activity</th>
              <th>Probe</th>
              <th>RTT med</th>
              <th>p95</th>
              <th>Jitter</th>
              <th>Loss %</th>
              <th>Hops</th>
              <th>Last-hop RTT</th>
            </tr>
          </thead>
          <tbody id="rows"></tbody>
        </table>
      </div>
      <p class="note">Note: results usually arrive within ~3–15s; we poll with backoff up to ~75s.</p>
    </div>

    <p class="footer">API base: <code id="apiShow"></code></p>
  </div>

  <script>
    // --- Config: set this if you serve API elsewhere ---
    const API_BASE = (window.NEXT_PUBLIC_API_BASE) || 'https://api.whl.freshcuppa.wtf';
    document.getElementById('apiShow').textContent = API_BASE;

    // ASN seeds (label -> number)
    const ASN_OPTIONS = [
      { label: 'Telstra – AU (AS1221)', value: 1221 },
      { label: 'Aussie Broadband – AU (AS4764)', value: 4764 },
      { label: 'Superloop – AU (AS38195)', value: 38195 },
      { label: 'TPG – AU (AS7545)', value: 7545 },
      { label: 'Optus – AU (AS4804)', value: 4804 },
      { label: 'iiNet – AU (AS4739)', value: 4739 }
    ];

    // Capitals (full names -> code used by worker)
    const CAPITALS = [
      { label: 'Sydney',   code: 'SYD' },
      { label: 'Melbourne',code: 'MEL' },
      { label: 'Brisbane', code: 'BNE' },
      { label: 'Adelaide', code: 'ADL' },
      { label: 'Perth',    code: 'PER' },
      { label: 'Canberra', code: 'CBR' },
      { label: 'Hobart',   code: 'HBA' },
      { label: 'Darwin',   code: 'DRW' },
      { label: 'Auckland', code: 'AKL' },
      { label: 'Wellington', code: 'WLG' },
      { label: 'Christchurch', code: 'CHC' },
    ];

    // --- State
    let WORLDS = []; // loaded from /data/worlds-au-nz.json
    const rows = document.getElementById('rows');
    const worldsList = document.getElementById('worldsList');
    const dbgBox = document.getElementById('dbgBox');
    const dbg = document.getElementById('dbg');
    const msg = document.getElementById('msg');
    const runBtn = document.getElementById('runBtn');
    const probeLine = document.getElementById('probeLine');

    // --- UI bootstrap
    (function init(){
      // asn
      const asnSel = document.getElementById('asnSel');
      ASN_OPTIONS.forEach(o => {
        const opt = document.createElement('option');
        opt.value = String(o.value);
        opt.textContent = o.label;
        asnSel.appendChild(opt);
      });

      // capital
      const capSel = document.getElementById('capSel');
      CAPITALS.forEach(c => {
        const opt = document.createElement('option');
        opt.value = c.code;
        opt.textContent = c.label;
        capSel.appendChild(opt);
      });
      // defaults that match your earlier tests
      asnSel.value = '1221';
      capSel.value = 'MEL';

      // load worlds
      fetch('./data/worlds-au-nz.json', { cache: 'no-store' })
        .then(r => r.json())
        .then(list => { WORLDS = list; renderWorlds(list); })
        .catch(e => setMsg('Failed to load world list: ' + e, true));

      runBtn.addEventListener('click', onRun);
    })();

    function renderWorlds(list){
      worldsList.innerHTML = '';
      list.forEach((w, idx) => {
        const id = 'w_' + idx;
        const div = document.createElement('label');
        div.className = 'world';
        div.innerHTML = `
          <input type="checkbox" id="${id}" data-host="${w.host}" data-port="${w.port}" />
          <div>
            <div><strong>${w.name}</strong></div>
            <div class="muted">${w.host} • ${w.activity || '—'}</div>
          </div>
        `;
        worldsList.appendChild(div);
      });
    }

    function setMsg(t, isErr){
      msg.textContent = t || '';
      msg.style.color = isErr ? 'var(--bad)' : 'var(--muted)';
    }
    function showDebug(obj){
      dbgBox.style.display = 'block';
      dbg.textContent = JSON.stringify(obj, null, 2);
    }

    function worldSelection(max=5){
      const picked = [...worldsList.querySelectorAll('input[type="checkbox"]:checked')]
        .slice(0, max)
        .map(ch => ch.getAttribute('data-host'));
      return picked;
    }

    function activityFor(host){
      const w = WORLDS.find(x => x.host === host);
      return w?.activity || '';
    }
    function membersFor(host){
      const w = WORLDS.find(x => x.host === host);
      return w?.members ? 'Members' : 'Free';
    }

    async function onRun(){
      setMsg('');
      probeLine.textContent = '';
      rows.innerHTML = '';
      runBtn.disabled = true;

      const asn = Number(document.getElementById('asnSel').value);
      const capital = document.getElementById('capSel').value;
      const port = Number(document.getElementById('portSel').value);
      const worlds = worldSelection(5);

      if (!worlds.length){
        setMsg('Pick at least one world.', true);
        runBtn.disabled = false;
        return;
      }

      // seed rows
      for(const host of worlds){
        const tr = document.createElement('tr');
        tr.id = 'row_' + host;
        tr.innerHTML = `
          <td><strong>${host}</strong></td>
          <td><span class="badge ${WORLDS.find(w=>w.host===host)?.members?'m':'f'}">${membersFor(host)}</span></td>
          <td>${activityFor(host) || '—'}</td>
          <td class="muted">—</td>
          <td class="stat">—</td>
          <td class="stat">—</td>
          <td class="stat">—</td>
          <td class="stat">—</td>
          <td class="stat">—</td>
          <td class="stat">—</td>
        `;
        rows.appendChild(tr);
      }

      try{
        // Create measurements
        const body = JSON.stringify({ asn, capital, worlds, tcp_port: port });
        const r = await fetch(API_BASE + '/measure', {
          method:'POST',
          headers:{ 'content-type':'application/json' },
          body
        });
        if (!r.ok){
          const txt = await r.text();
          throw new Error('measure failed ' + r.status + ': ' + txt);
        }
        const data = await r.json();
        showDebug({ measure_response: data });

        const runId = data.run_id;
        const probeId = data.probe_id;
        probeLine.textContent = 'Probe: ' + probeId + ' • run ' + runId;

        // Poll /results with backoff: 1s,2s,3s,5s,8s,12s,16s (≈47s), keep a couple more polls
        const waits = [1000,2000,3000,5000,8000,12000,16000,16000,16000];
        for (let i=0;i<waits.length;i++){
          await new Promise(res => setTimeout(res, waits[i]));
          const rr = await fetch(API_BASE + '/results?run=' + encodeURIComponent(runId));
          if (!rr.ok) continue;
          const res = await rr.json();
          renderResults(res.results || []);
          // done if we have samples or traceroute hops on every requested world
          if (doneEnough(res.results || [], worlds)) break;
        }
        setMsg('Done.');
      }catch(e){
        setMsg(String(e.message || e), true);
      }finally{
        runBtn.disabled = false;
      }
    }

    function doneEnough(results, wantedHosts){
      if (!results.length) return false;
      const byHost = Object.fromEntries(results.map(r=>[r.world, r]));
      return wantedHosts.every(h => {
        const r = byHost[h];
        if (!r) return false;
        const pingOk = r.ping && (r.ping.samples || 0) > 0;
        const trOk = r.traceroute && (r.traceroute.hops || 0) > 0;
        return pingOk || trOk;
      });
    }

    function fmt(n, digits=3){
      return (n==null || Number.isNaN(n)) ? '—' : Number(n).toFixed(digits);
    }
    function renderResults(arr){
      for (const r of arr){
        const tr = document.getElementById('row_' + r.world);
        if (!tr) continue;
        const tds = tr.querySelectorAll('td');
        // 0 world, 1 members badge, 2 activity
        tds[3].textContent = r.probe_id || document.getElementById('probeLine').textContent.replace(/^Probe:\s*/,'').split('•')[0].trim();
        tds[4].textContent = fmt(r?.ping?.rtt_med);
        tds[5].textContent = fmt(r?.ping?.rtt_p95);
        tds[6].textContent = fmt(r?.ping?.jitter);
        tds[7].textContent = (r?.ping?.loss_pct==null) ? '—' : String(r.ping.loss_pct);
        tds[8].textContent = (r?.traceroute?.hops==null)?'—':String(r.traceroute.hops);
        tds[9].textContent = fmt(r?.traceroute?.final_hop_rtt);
      }
    }
  </script>
</body>
</html>
