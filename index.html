<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>World Hopper Labs — AU/NZ</title>
  <link rel="icon" href="favicon.ico" />
  <style>
    :root{
      --bg:#0b1220; --panel:#121a2a; --muted:#7b8aa5; --text:#e8eefc;
      --accent:#1f6feb; --accent-2:#2ea043; --chip:#1b263b; --chip2:#22314b;
      --danger:#ff5470; --ok:#2ea043; --card:#111a2a; --border:#1c2740;
    }
    *{box-sizing:border-box}
    html,body{margin:0;height:100%;background:var(--bg);color:var(--text);font:16px/1.4 system-ui,Segoe UI,Roboto,Helvetica,Arial}
    a{color:var(--accent)}
    .wrap{max-width:1200px;margin:24px auto;padding:0 16px}
    h1{margin:0 0 8px;font-size:28px}
    .subtitle{color:var(--muted);margin-bottom:18px}
    .grid{
      display:grid;
      grid-template-columns: 1.15fr 1.85fr; /* expand section 1 */
      gap:18px;
    }
    @media (max-width: 980px){ .grid{ grid-template-columns: 1fr; } }

    .panel{
      background:var(--panel); border:1px solid var(--border); border-radius:10px; padding:16px 16px 12px;
    }
    .panel h2{font-size:18px;margin:0 0 12px}
    .help{color:var(--muted);font-size:13px;margin-top:8px}
    .row{display:flex;gap:10px;align-items:center;flex-wrap:wrap}
    .ctrl{display:flex;flex-direction:column;gap:6px;min-width:220px;flex:1}
    .ctrl label{font-size:13px;color:var(--muted)}
    select, input[type="text"], input[type="number"]{
      background:#0e1626;color:var(--text);border:1px solid var(--border);border-radius:8px;padding:10px 12px;outline:none;
    }
    select:focus, input:focus{border-color:var(--accent)}
    .checkbox{display:flex;align-items:center;gap:8px;margin-top:10px}
    .muted{color:var(--muted);font-size:13px}

    /* worlds grid */
    .worlds-grid{
      display:grid;
      grid-template-columns: repeat(3, minmax(0,1fr));
      gap:12px;
    }
    @media (max-width: 1100px){ .worlds-grid{ grid-template-columns: repeat(2, minmax(0,1fr)); } }
    @media (max-width: 680px){ .worlds-grid{ grid-template-columns: 1fr; } }

    .card{
      background:var(--card); border:1px solid var(--border); border-radius:10px; padding:12px;
      display:flex;flex-direction:column;gap:8px;
    }
    .card h3{margin:0;font-size:16px}
    .host{color:var(--muted);font-size:12px;word-break:break-all}
    .chips{display:flex;gap:6px;flex-wrap:wrap}
    .chip{background:var(--chip);border:1px solid var(--border);color:#cfe1ff;border-radius:999px;padding:4px 8px;font-size:12px}
    .chip.alt{background:var(--chip2)}
    .card .foot{display:flex;justify-content:space-between;align-items:center;margin-top:6px}
    .btn{
      appearance:none; border:1px solid var(--border); background:var(--accent); color:white;
      border-radius:8px; padding:9px 12px; cursor:pointer; font-weight:600;
    }
    .btn.secondary{ background:#0f1a31; color:#d1e4ff }
    .btn.small{ padding:6px 10px; font-size:13px }
    .btn:disabled{opacity:.6;cursor:not-allowed}

    /* results table */
    table{width:100%;border-collapse:collapse;margin-top:8px}
    th, td{padding:10px;border-bottom:1px solid var(--border);text-align:left;font-size:14px}
    th{color:#b8c6e0;font-weight:600}
    .status{font-size:12px}
    .ok{color:var(--ok)} .err{color:var(--danger)}
    .notice{color:var(--muted);font-size:12px;margin:6px 0 0}
  </style>
</head>
<body>
  <div class="wrap">
    <h1>World Hopper Labs — AU/NZ</h1>
    <div class="subtitle">Quickly test RTT / loss and TCP hope count from a RIPE Atlas probe connected with your ISP, in your City, to OSRS worlds.</div>

    <div class="grid">
      <!-- SECTION 1 -->
      <section class="panel" id="sec-net">
        <h2>1) Choose network &amp; region</h2>

        <div class="row">
          <div class="ctrl" style="min-width:260px">
            <label for="asnSel">ISP (ASN)</label>
            <select id="asnSel" aria-label="ISP/ASN"></select>
          </div>

          <div class="ctrl" style="min-width:220px">
            <label for="citySel">Closest city</label>
            <select id="citySel">
              <option value="MEL">Melbourne</option>
              <option value="SYD">Sydney</option>
              <option value="BNE">Brisbane</option>
              <option value="ADL">Adelaide</option>
              <option value="PER">Perth</option>
              <option value="CBR">Canberra</option>
              <option value="HBA">Hobart</option>
              <option value="DRW">Darwin</option>
              <option value="AKL">Auckland</option>
              <option value="WLG">Wellington</option>
              <option value="CHC">Christchurch</option>
            </select>
          </div>

          <div class="ctrl" style="min-width:200px">
            <label for="portSel">Game port</label>
            <select id="portSel">
              <option value="43594" selected>43594</option>
              <option value="43595">43595</option>
            </select>
          </div>
        </div>

        <label class="checkbox">
          <input id="nocache" type="checkbox" />
          <span>Bypass probe cache (force fresh selection)</span>
        </label>

        <div class="help">
          CORS is limited to this Pages domain; your browser will call <code>https://api.whl.freshcuppa.wtf</code>.
        </div>
      </section>

      <!-- SECTION 2 -->
      <section class="panel">
        <h2>2) Pick worlds</h2>
        <div id="worlds" class="worlds-grid"></div>

        <div style="display:flex;align-items:center;gap:8px;margin-top:10px">
          <button id="toggleWorlds" class="btn secondary small">Show all</button>
          <span class="muted">Select up to 5 worlds.</span>
          <div style="flex:1"></div>
          <button id="startBtn" class="btn">Start measurement</button>
        </div>
      </section>
    </div>

    <!-- SECTION 3 -->
    <section class="panel" style="margin-top:18px">
      <h2>3) Results</h2>
      <div class="table-wrap">
        <table id="resultsTbl">
          <thead>
            <tr>
              <th>World</th><th>Port</th><th>Members</th><th>Activity</th>
              <th>Median RTT</th><th>p95 RTT</th><th>Jitter</th><th>Loss %</th>
              <th>Hops</th><th>Final hop RTT</th><th>Status</th>
            </tr>
          </thead>
          <tbody id="resultsBody"></tbody>
        </table>
      </div>
      <div class="notice">Note: results usually arrive within ~3–15s; we poll with backoff up to ~75s.</div>
    </section>
  </div>

  <script>
  // ---------- Config ----------
  const API_BASE = (window.location.hostname.endsWith(".freshcuppa.wtf"))
    ? "https://api.whl.freshcuppa.wtf" : "http://localhost:8787";

  const MAX_WORLDS = 5;
  let WORLD_LIST = [];
  let SHOW_ALL = false;

  // ---------- DOM ----------
  const asnSel = document.getElementById('asnSel');
  const citySel = document.getElementById('citySel');
  const portSel = document.getElementById('portSel');
  const nocacheChk = document.getElementById('nocache');
  const worldsDiv = document.getElementById('worlds');
  const toggleWorldsBtn = document.getElementById('toggleWorlds');
  const startBtn = document.getElementById('startBtn');
  const resultsBody = document.getElementById('resultsBody');

  // ---------- Load seeds (ISP + worlds) ----------
  async function loadASNSeeds(){
    try{
      const r = await fetch('asn-seeds.json', { cache: 'no-store' });
      if(!r.ok) throw new Error('asn-seeds load failed: '+r.status);
      const json = await r.json();

      // Make AU + NZ flat list with labels like "Telstra — AU (AS1221)"
      const flat = [];
      for(const [cc, items] of Object.entries(json)){
        for(const it of items){
          flat.push({ label: `${it.label} — ${cc} (AS${it.asn})`, asn: it.asn, cc });
        }
      }
      flat.sort((a,b)=> a.label.localeCompare(b.label));
      asnSel.innerHTML = '';
      for(const it of flat){
        const opt = document.createElement('option');
        opt.value = it.asn;
        opt.textContent = it.label;
        asnSel.appendChild(opt);
      }
      // Preselect Telstra if present
      const telstra = flat.find(x=>/Telstra/i.test(x.label));
      if(telstra) asnSel.value = telstra.asn;
    }catch(e){
      console.error(e);
      asnSel.innerHTML = `<option value="1221">Telstra — AU (AS1221)</option>`;
    }
  }

  async function loadWorlds(){
    const r = await fetch('worlds-au-nz.json', { cache:'no-store' });
    if(!r.ok) throw new Error('worlds-au-nz.json failed');
    WORLD_LIST = await r.json();
    renderWorlds();
  }

  // ---------- Render worlds ----------
  function renderWorlds(){
    worldsDiv.innerHTML = '';
    const list = SHOW_ALL ? WORLD_LIST : WORLD_LIST.slice(0, 6);
    for(const w of list){
      const id = `w_${w.host}`;
      const card = document.createElement('div');
      card.className = 'card';
      card.innerHTML = `
        <h3>${w.name}</h3>
        <div class="host">${w.host} : ${w.port}</div>
        <div class="chips">
          <span class="chip">${w.members ? 'Members' : 'Free'}</span>
          ${w.activity ? `<span class="chip alt">${escapeHtml(w.activity)}</span>` : ''}
        </div>
        <div class="foot">
          <label class="checkbox" style="gap:6px;margin:0">
            <input type="checkbox" class="w-check" data-host="${w.host}" />
            <span class="muted">Include in measurement</span>
          </label>
          <button class="btn small secondary sel-btn" data-host="${w.host}">Select</button>
        </div>
      `;
      worldsDiv.appendChild(card);
    }
    toggleWorldsBtn.textContent = SHOW_ALL ? `Show fewer` : `Show all (${WORLD_LIST.length})`;
    wireWorldButtons();
  }

  function wireWorldButtons(){
    const checks = worldsDiv.querySelectorAll('.w-check');
    const selBtns = worldsDiv.querySelectorAll('.sel-btn');

    const enforceLimit = () => {
      const selected = [...document.querySelectorAll('.w-check:checked')];
      if(selected.length > MAX_WORLDS){
        selected.slice(MAX_WORLDS).forEach(c => c.checked = false);
        alert(`You can select up to ${MAX_WORLDS} worlds.`);
      }
    };

    checks.forEach(c => c.addEventListener('change', enforceLimit));
    selBtns.forEach(btn => {
      btn.addEventListener('click', () => {
        const host = btn.dataset.host;
        const cb = worldsDiv.querySelector(`.w-check[data-host="${CSS.escape(host)}"]`);
        if(cb){ cb.checked = !cb.checked; enforceLimit(); }
      });
    });
  }

  toggleWorldsBtn.addEventListener('click', () => {
    SHOW_ALL = !SHOW_ALL;
    renderWorlds();
  });

  // ---------- Measurement flow ----------
  function selectedWorlds(){
    const hosts = [...document.querySelectorAll('.w-check:checked')].map(el => el.dataset.host);
    return WORLD_LIST.filter(w => hosts.includes(w.host));
  }

  function addRowSkeleton(w){
    const tr = document.createElement('tr');
    tr.id = `row_${w.host}`;
    tr.innerHTML = `
      <td>${w.name}<div class="muted" style="font-size:12px">${w.host}</div></td>
      <td>${w.port}</td>
      <td>${w.members ? 'Members' : 'Free'}</td>
      <td>${escapeHtml(w.activity || '')}</td>
      <td>—</td><td>—</td><td>—</td><td>—</td><td>—</td><td>—</td>
      <td class="status muted">queued…</td>
    `;
    resultsBody.appendChild(tr);
  }

  function updateRow(host, obj){
    const tr = document.getElementById(`row_${host}`);
    if(!tr) return;
    const tds = tr.querySelectorAll('td');
    const ping = obj.ping || {};
    const trc = obj.traceroute || {};
    tds[4].textContent = numOrDash(ping.rtt_med);
    tds[5].textContent = numOrDash(ping.rtt_p95);
    tds[6].textContent = numOrDash(ping.jitter);
    tds[7].textContent = numOrDash(ping.loss_pct);
    tds[8].textContent = trc.hops ?? '—';
    tds[9].textContent = numOrDash(trc.final_hop_rtt);
    const st = tr.querySelector('.status');
    if(ping.samples > 0 || trc.hops){ st.textContent = 'done'; st.className = 'status ok'; }
  }

  startBtn.addEventListener('click', async () => {
    const worlds = selectedWorlds();
    if(worlds.length === 0) return alert('Pick at least one world.');
    resultsBody.innerHTML = '';
    worlds.forEach(addRowSkeleton);

    const asn = Number(asnSel.value || '1221');
    const capital = citySel.value || 'MEL';
    const port = Number(portSel.value || '43594');
    const nocache = nocacheChk.checked ? '&nocache=1' : '';

    // create measurement
    try{
      const body = {
        asn, capital, tcp_port: port,
        worlds: worlds.map(w => w.host)
      };
      const r = await fetch(`${API_BASE}/measure${nocache}`, {
        method:'POST', headers:{'content-type':'application/json'}, body: JSON.stringify(body)
      });
      if(!r.ok){
        const txt = await r.text(); throw new Error(`measure ${r.status}: ${txt}`);
      }
      const data = await r.json();
      pollResults(data.run_id, worlds);
    }catch(e){
      console.error(e);
      alert('Failed to start measurement.');
    }
  });

  async function pollResults(runId, worlds){
    let delay = 1500, tries = 0;
    const maxTries = 18; // ~75s
    while(tries++ < maxTries){
      await wait(delay);
      delay = Math.min(6000, Math.round(delay * 1.35));

      let resp;
      try{
        resp = await fetch(`${API_BASE}/results?run=${encodeURIComponent(runId)}`, { cache:'no-store' });
      }catch(e){ continue; }
      if(!resp?.ok) continue;

      const json = await resp.json();
      const arr = json.results || [];
      arr.forEach(res => {
        const w = worlds.find(x => x.host === res.world);
        if(w) updateRow(w.host, res);
      });

      // stop early if all have data
      const done = arr.every(r => (r?.ping?.samples > 0) || (r?.traceroute?.hops));
      if(done) break;
    }
  }

  // ---------- Utils ----------
  const wait = ms => new Promise(r => setTimeout(r, ms));
  const numOrDash = v => (v === null || v === undefined) ? '—' : (typeof v === 'number' ? v.toFixed(3) : v);
  const escapeHtml = s => String(s).replace(/[&<>"']/g, c => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[c]));

  // ---------- Init ----------
  (async function init(){
    await loadASNSeeds();
    await loadWorlds();
  })();
  </script>
</body>
</html>
